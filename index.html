<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bububurger - Menú</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #fff200; /* Amarillo vibrante como tu logo */
      flex-direction: column;
    }
    img {
      max-width: 250px;
      height: auto;
      animation: pulse 1.5s infinite;
      user-select: none;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    p {
      font-family: Arial, sans-serif;
      margin-top: 15px;
      font-weight: bold;
      font-size: 18px;
      color: #000;
    }
  </style>
</head>
<body>
  <img src="logo-bubu.png" alt="Bububurger">
  <p>Cargando menú...</p>

  <script>
    // Tu Apps Script y menú:
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzB8UVibJniBM_nLe6LSRRVeuV9OGZIVl1fN6gJYSaYz7cnLWKU0dJUqwn1a61ZEEAB/exec";
    const MENU_URL   = "https://menu-bububurger.netlify.app/";
  
    // Tiempos
    const REDIRECT_DELAY = 2500;  // ms en pantalla de carga
    const LOG_TIMEOUT    = 1200;  // ms máx. para intentar registrar
    const DEDUP_MS       = 15000; // ventana anti-duplicado (15s)

    function redirect() {
      window.location.href = MENU_URL;
    }
  
    async function getClientIP() {
      try {
        const r = await fetch("https://api.ipify.org?format=json");
        const j = await r.json();
        return j.ip || "unknown";
      } catch { return "unknown"; }
    }
  
    async function logScan() {
      try {
        // --- Anti-duplicado en el cliente ---
        const now = Date.now();
        const last = Number(sessionStorage.getItem("bubu_last_log") || 0);
        if (now - last < DEDUP_MS) return;  // ya se registró hace poco
        sessionStorage.setItem("bubu_last_log", String(now));

        // Datos
        const ip = await Promise.race([
          getClientIP(),
          new Promise(res => setTimeout(() => res("timeout"), 800))
        ]);
        const ua = navigator.userAgent || "unknown";
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "unknown";
        const ref = document.referrer || "direct";
        const eid = `${now}-${Math.random().toString(36).slice(2,8)}`; // ID único del evento
        const payload = JSON.stringify({ ip, ua, tz, ref, path: location.href, eid });
  
        // 1) Intento con sendBeacon (no bloquea)
        if (navigator.sendBeacon) {
          const ok = navigator.sendBeacon(SCRIPT_URL, new Blob([payload], { type: "application/json" }));
          if (ok) return;
        }
  
        // 2) Fallback con fetch + timeout/abort
        const ctrl = new AbortController();
        const timer = setTimeout(() => ctrl.abort(), LOG_TIMEOUT);
        await fetch(SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: payload,
          signal: ctrl.signal,
          keepalive: true
        }).catch(() => {});
        clearTimeout(timer);
      } catch { /* no estorbar */ }
    }
  
    (async () => {
      // Arranco intento de log, pero pase lo que pase, se redirige
      logScan();
      setTimeout(redirect, REDIRECT_DELAY);
    })();
  </script>
  
</body>
</html>
