<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bububurger - Menú</title>
  <style>
    body { margin:0; height:100vh; display:flex; justify-content:center; align-items:center; background:#fff200; flex-direction:column; font-family:Arial, sans-serif; color:#000; }
    img { max-width:250px; height:auto; animation:pulse 1.5s infinite; user-select:none; }
    @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.1)} 100%{transform:scale(1)} }
    p { margin-top:15px; font-weight:bold; font-size:18px; }
  </style>
</head>
<body>
  <img src="logo-bubu.png" alt="Bububurger"/>
  <p>Cargando menú...</p>

  <script>
    // === Config ===
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzB8UVibJniBM_nLe6LSRRVeuV9OGZIVl1fN6gJYSaYz7cnLWKU0dJUqwn1a61ZEEAB/exec"; // v4
    const MENU_URL   = "https://menu-bububurger.netlify.app/";
    const REDIRECT_DELAY = 2500;  // se queda en 2.5s
    const LOG_TIMEOUT    = 1200;
    const DEDUP_MS       = 15000;

    function nowId(){ return `${Date.now()}-${Math.random().toString(36).slice(2,8)}` }

    async function getClientIP(){
      try {
        const r = await fetch("https://api.ipify.org?format=json", {cache:"no-store"});
        const j = await r.json();
        return j.ip || "unknown";
      } catch { return "unknown" }
    }

    function sendLogPayload(payloadStr){
      try{
        if (navigator.sendBeacon){
          const ok = navigator.sendBeacon(SCRIPT_URL, new Blob([payloadStr], {type:"application/json"}));
          if (ok) return true;
        }
        const ctrl = new AbortController();
        const to = setTimeout(()=>ctrl.abort(), LOG_TIMEOUT);
        fetch(SCRIPT_URL, {
          method:"POST", mode:"no-cors",
          headers:{"Content-Type":"application/json"},
          body: payloadStr, signal: ctrl.signal, keepalive:true
        }).catch(()=>{}).finally(()=>clearTimeout(to));
        return true;
      }catch{ return false }
    }

    // Fallback por GET-pixel: SIEMPRE intenta un golpe al /exec
    function pingGet(){
      const img = new Image();
      img.referrerPolicy = "no-referrer";
      img.src = SCRIPT_URL + "?t=" + Date.now();   // esto dispara tu doGet
    }

    let sentOnce = false;

    async function logScan(){
      try{
        // Anti-duplicado en cliente
        const now = Date.now();
        const last = Number(sessionStorage.getItem("bubu_last_log")||0);
        if (now - last < DEDUP_MS) return;
        sessionStorage.setItem("bubu_last_log", String(now));

        // Datos para POST
        const ip  = await Promise.race([ getClientIP(), new Promise(res=>setTimeout(()=>res("timeout"),800)) ]);
        const ua  = navigator.userAgent || "unknown";
        const tz  = Intl.DateTimeFormat().resolvedOptions().timeZone || "unknown";
        const ref = document.referrer || "direct";
        const eid = nowId();
        const payload = JSON.stringify({ ip, ua, tz, ref, path: location.href, eid });

        // 1) POST (beacon/fetch)
        sentOnce = sendLogPayload(payload);
        // 2) Fallback inmediato por GET (garantiza registro en entornos caprichosos)
        pingGet();

        // 3) Reintento silente a los 600ms si hiciera falta
        setTimeout(()=>{ if(!sentOnce) sendLogPayload(payload); }, 600);

        // 4) Y al salir/ocultar, otro ping GET (no duplica porque tu servidor usa cache/eid)
        const finalPing = ()=> pingGet();
        document.addEventListener("visibilitychange", ()=>{ if (document.visibilityState!=="visible") finalPing(); }, {once:true});
        window.addEventListener("pagehide", finalPing, {once:true});

      }catch{/* no bloquear */}
    }

    (async ()=>{
      logScan();                                 // al entrar
      setTimeout(()=>{ window.location.href = MENU_URL; }, REDIRECT_DELAY); // redirigir a los 2.5s
    })();
  </script>
</body>
</html>
