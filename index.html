<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bububurger - Menú</title>
  <style>
    body { margin:0; height:100vh; display:flex; justify-content:center; align-items:center; background:#fff200; flex-direction:column; font-family:Arial, sans-serif; color:#000; }
    img { max-width:250px; height:auto; animation:pulse 1.5s infinite; user-select:none; }
    @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.1)} 100%{transform:scale(1)} }
    p { margin-top:15px; font-weight:bold; font-size:18px; }
  </style>
</head>
<body>
  <img src="logo-bubu.png" alt="Bububurger"/>
  <p>Cargando menú...</p>

  <script>
    // === Config ===
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxg0-20LW0T6TZ5f_eube3TAQd6mCbjeNWUHl9W8ATuRLpGpjn2Bhnh0PtYh-6z9hQa/exec"; // v7
    const MENU_URL   = "https://menu-bububurger.netlify.app/";
    const REDIRECT_DELAY = 2500;  // 2.5s pantalla de carga
    const DEDUP_MS       = 15000; // anti-doble en cliente (15s)

    // Un solo EID por visita (se reutiliza en GETs)
    const EID = `${Date.now()}-${Math.random().toString(36).slice(2,8)}`;

    async function getClientIP(){
      try {
        const r = await fetch("https://api.ipify.org?format=json", {cache:"no-store"});
        const j = await r.json();
        return j.ip || "unknown";
      } catch { return "unknown"; }
    }

    // GET completo con todos los datos (cuenta como 'intermediate')
    function sendGetFull({ip, ua, tz, ref, eid}) {
      const q = new URLSearchParams({
        eid, ip, ua, tz, ref,
        path: location.href // esto hace que el servidor marque 'intermediate'
      });
      const url = `${SCRIPT_URL}?${q.toString()}`;
      try {
        if (!navigator.sendBeacon || !navigator.sendBeacon(url)) {
          fetch(url, { method: "GET", mode: "no-cors", keepalive: true }).catch(()=>{});
        }
      } catch (_) {
        fetch(url, { method: "GET", mode: "no-cors", keepalive: true }).catch(()=>{});
      }
    }

    // Pixel mínimo de respaldo (quedará como 'doGet', no suma a KPIs)
    function pingPixel(eid, ip){
      const img = new Image();
      img.referrerPolicy = "no-referrer";
      img.src = `${SCRIPT_URL}?eid=${encodeURIComponent(eid)}&ip=${encodeURIComponent(ip || "unknown")}&t=${Date.now()}`;
    }

    (async ()=>{
      // Anti-duplicado en cliente
      const now  = Date.now();
      const last = Number(sessionStorage.getItem("bubu_last_log")||0);
      if (now - last < DEDUP_MS) return;
      sessionStorage.setItem("bubu_last_log", String(now));

      // Datos para el GET completo
      const ip  = await Promise.race([ getClientIP(), new Promise(res=>setTimeout(()=>res("timeout"),800)) ]);
      const ua  = navigator.userAgent || "unknown";
      const tz  = Intl.DateTimeFormat().resolvedOptions().timeZone || "unknown";
      const ref = document.referrer || "direct";

      // 1) Registro principal (cuenta) por GET completo
      sendGetFull({ip, ua, tz, ref, eid: EID});

      // 2) Pixel de respaldo (no cuenta)
      pingPixel(EID, ip);

      // 3) Reintento al salir/ocultar (por si el navegador mató la pestaña)
      const finalPing = ()=> sendGetFull({ip, ua, tz, ref, eid: EID});
      document.addEventListener("visibilitychange", ()=>{ if (document.visibilityState!=="visible") finalPing(); }, {once:true});
      window.addEventListener("pagehide", finalPing, {once:true});

      // Redirección a tu menú
      setTimeout(()=>{ window.location.href = MENU_URL; }, REDIRECT_DELAY);
    })();
  </script>
</body>
</html>
